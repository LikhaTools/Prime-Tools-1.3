<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Order Checker 2.1</title>

<style>
:root{
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;

  --green:#22c55e;
  --red:#ef4444;
  --yellow:#facc15;
  --blue:#2563eb;
}

*{ box-sizing:border-box; }

body{
  margin:0;
  padding:24px;
  font-family:'Segoe UI', system-ui, sans-serif;
  background:var(--bg);
  color:var(--text);
}

h2{ text-align:center; margin-top:0; }

.container{
  display:grid;
  grid-template-columns:380px 1fr;
  gap:20px;
}

.card{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  box-shadow:0 8px 25px rgba(0,0,0,0.06);
}

textarea{
  width:100%;
  height:240px;
  resize:none;
  padding:12px;
  border-radius:10px;
  border:1px solid #cbd5e1;
  font-family:monospace;
}

button{
  margin-top:12px;
  padding:8px 14px;
  border:none;
  border-radius:8px;
  background:var(--blue);
  color:#fff;
  font-size:14px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:6px;
  transition:.25s;
}
button:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(0,0,0,0.15);
}

.copy-btn{ background:#16a34a; }
.copy-btn:hover{ background:#15803d; }

.status{
  margin-left:auto;
  font-size:13px;
  font-weight:bold;
}
.loading{ color:#f59e0b; }
.success{ color:var(--green); }
.error{ color:var(--red); }

.loader{
  width:16px;
  height:16px;
  border:2px solid #fff;
  border-top:2px solid transparent;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg); } }

.page-card{
  border-radius:12px;
  border:1px solid #e2e8f0;
  margin-bottom:14px;
  overflow:hidden;
}

.page-header{
  padding:14px 16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}

.page-header.green{ background:#ecfdf5; }
.page-header.red{ background:#fef2f2; }
.page-header.yellow{ background:#fffbeb; }

.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
  margin-left:6px;
}
.badge.green{ background:#dcfce7; color:#166534; }
.badge.red{ background:#fee2e2; color:#7f1d1d; }
.badge.yellow{ background:#fef9c3; color:#854d0e; }

.page-body{ display:none; padding:12px 16px; }
.page-card.open .page-body{ display:block; }

table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}
th,td{
  padding:8px;
  border-bottom:1px solid #e2e8f0;
}
tr.missing{ background:#fee2e2; }
tr.duplicate{ background:#fef9c3; }
tr.found{ background:#dcfce7; }

.toggle-found-btn{
  margin:6px 0;
  padding:4px 8px;
  font-size:12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#2563eb;
  color:#fff;
}

pre{
  margin-top:12px;
  font-size:13px;
  white-space:pre-wrap;
  background:#f8fafc;
  padding:10px;
  border-radius:8px;
  border:1px solid #e2e8f0;
}

@media(max-width:900px){
  .container{ grid-template-columns:1fr; }
}
</style>
</head>

<body>

<h2>ðŸ“Š ORDER CHECKER 2.1</h2>

<div class="container">

<div class="card">
  <h3>Website Data</h3>
  <small>Format: Page Name[TAB]Customer Name</small>
  <textarea id="input"></textarea>

  <button onclick="process()">
    <span id="btnText">CHECK</span>
    <span id="loader" style="display:none" class="loader"></span>
    <span id="status" class="status loading">Connectingâ€¦</span>
  </button>

  <button class="copy-btn" onclick="copySummary()">COPY SUMMARY</button>

  <pre id="reportSummary"></pre>
</div>

<div class="card">
  <h3>Results</h3>
  <div id="result">Waiting for inputâ€¦</div>
</div>

</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwMf1vVIX5b7PI-0hOL62AFT2AZ2qObIDg4MDHIrekxHQEqT5AzBVyOMNchY4zKTV8yJg/exec";
let sheetPairs=[];
let loading=false;

async function fetchSheet(){
  const status=document.getElementById("status");
  try{
    const res=await fetch(WEB_APP_URL);
    sheetPairs=await res.json();
    status.textContent="GSheet Ready";
    status.className="status success";
  }catch{
    status.textContent="GSheet Error";
    status.className="status error";
    sheetPairs=[];
  }
}
fetchSheet();

function process(){
  if(loading) return;
  loading=true;
  document.getElementById("loader").style.display="inline-block";
  document.getElementById("btnText").textContent="Checkingâ€¦";
  setTimeout(runLogic,300);
}

function runLogic(){
  const raw=document.getElementById("input").value.trim();
  if(!raw){ loadingDone(); return; }

  const websiteCount={};
  raw.split("\n").forEach(l=>{
    const [p,c]=l.split("\t").map(v=>v?.trim());
    if(!p||!c) return;
    const k=`${p}|||${c}`;
    websiteCount[k]=(websiteCount[k]||0)+1;
  });

  const sheetCount={};
  sheetPairs.forEach(k=>{
    sheetCount[k]=(sheetCount[k]||0)+1;
  });

  const pages={};
  Object.keys({...websiteCount,...sheetCount}).forEach(k=>{
    const [p,c]=k.split("|||");
    pages[p]??=[];
    pages[p].push({
      page:p,
      customer:c,
      website:websiteCount[k]||0,
      gsheet:sheetCount[k]||0
    });
  });

  /* YESTERDAY DATE */
  const d=new Date();
  d.setDate(d.getDate()-1);
  const reportDate=d.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"2-digit"});

  let websiteTotal=Object.values(websiteCount).reduce((a,b)=>a+b,0);
  let gsheetTotal=sheetPairs.length;

  let report=`${reportDate}
Total Orders from Likha Website - ${websiteTotal}
Total Orders from Likha Gsheet - ${gsheetTotal}
`;

  let html="";

  Object.entries(pages).forEach(([page,rows])=>{
    let miss=0,dup=0,found=0;
    let pageReport=`\n${page}\n`;
    let hasIssue=false;

    rows.forEach(r=>{
      const w=r.website, g=r.gsheet;

      if(w>1 && g>1) return;

      let status="";
      if(w===0 && g>0){ status="MISSING (WEBSITE)"; miss++; }
      else if(g===0 && w>0){ status="MISSING (GSHEET)"; miss++; }
      else if(w>1 && g<=1){ status=`DUPLICATE (WEBSITE: ${w})`; dup++; }
      else if(g>1 && w<=1){ status=`DUPLICATE (GSHEET: ${g})`; dup++; }
      else if(w===1 && g===1){ status="MATCH"; found++; }

      if(status!=="MATCH"){
        hasIssue=true;
        pageReport+=`\n${r.customer}\nWEBSITE:${w} | GSheet:${g} ${status}\n`;
      }
    });

    if(hasIssue) report+=pageReport;

    const headerColor=miss>0?"red":dup>0?"yellow":"green";

    html+=`
    <div class="page-card">
      <div class="page-header ${headerColor}" onclick="this.parentElement.classList.toggle('open')">
        <div>
          <strong>${page}</strong><br>
          <small>
            WEBSITE:${rows.reduce((a,b)=>a+b.website,0)} |
            GSheet:${rows.reduce((a,b)=>a+b.gsheet,0)}
          </small>
        </div>
        <div>
          <span class="badge red">MISSING:${miss}</span>
          <span class="badge yellow">DUP:${dup}</span>
          <span class="badge green">FOUND:${found}</span>
        </div>
      </div>

      <div class="page-body">
        <button class="toggle-found-btn" onclick="
          const rows=this.parentElement.querySelectorAll('tr.found');
          rows.forEach(r=>r.style.display = r.style.display==='none'?'table-row':'none');
          this.textContent = this.textContent.includes('Show')?'Hide Found':'Show Found';
        ">Show Found</button>

        <table>
          <tr><th>Customer</th><th>Status</th></tr>
          ${rows.map(r=>{
            let cls="found",txt="FOUND",hideFound="";
            if(r.website===0||r.gsheet===0){
              cls="missing";
              txt=`MISSING (${r.website===0?"WEBSITE":"GSHEET"})`;
            }else if(r.website>1||r.gsheet>1){
              cls="duplicate";
              txt=`DUPLICATE`;
            }
            if(cls==='found') hideFound='style="display:none;"';
            return `<tr class="${cls}" ${hideFound}><td>${r.customer}</td><td>${txt}</td></tr>`;
          }).join("")}
        </table>
      </div>
    </div>`;
  });

  document.getElementById("result").innerHTML=html;
  document.getElementById("reportSummary").innerText=report.trim();
  loadingDone();
}

function loadingDone(){
  loading=false;
  document.getElementById("loader").style.display="none";
  document.getElementById("btnText").textContent="CHECK";
}

function copySummary(){
  const t=document.getElementById("reportSummary").innerText;
  if(!t) return alert("No summary");
  navigator.clipboard.writeText(t);
  alert("Summary copied");
}
</script>

</body>
</html>

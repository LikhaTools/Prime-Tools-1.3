<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>INVENTORY</title>
  <style>
    :root{
      --bg:#f4f6f8; --card:#ffffff; --muted:#64748b;
      --border:#3b82f6; --primary:#3b82f6; --primary-weak:#e8efff;
      --success:#16a34a; --text:#0f172a;
    }
    *{box-sizing:border-box}
    body { font-family: Inter, Arial, sans-serif; background:var(--bg); margin:0; color:var(--text) }
    h1 { margin:0 0 12px 0; font-size:20px }
    h2 { margin-top:14px; font-size:13px; color:var(--muted) }
    .app { display:grid; grid-template-columns: 32% 68%; height:100vh }
    .left { background:var(--card); padding:16px 16px 16px 40px; overflow:auto; border-right:1px solid #e5e7eb; border-radius:12px 0 0 12px }
    .right { padding:20px; overflow:auto; background:var(--card); border-radius:0 12px 12px 0 }
    textarea { width:100%; height:110px; padding:10px; font-size:13px; margin-top:6px; border:1px solid #e5e7eb; border-radius:8px; resize:vertical; font-family: monospace }
    .btn { padding:10px 14px; font-size:13px; background:var(--primary); color:#fff; border:none; border-radius:10px; cursor:pointer; transition: transform 0.2s, box-shadow 0.2s; margin-top:12px; }
    .btn:hover { transform: translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.15) }
    .btn.ghost{ background:var(--primary-weak); color:var(--primary) }
    .btn.full{ width:100% }
    .copy-tables{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:16px }
    .copy-tables div{ display:flex; flex-direction:column }
    .copy-tables textarea{ flex:1; height:250px; background:#f9f9f9; color:#0f172a; border:1px solid var(--border) }
    table { width:100%; border-collapse:collapse; background:var(--card); border:1px solid var(--border); border-radius:10px; table-layout: fixed }
    th, td { border-bottom:1px solid var(--border); padding:10px; text-align:center; font-size:13px; word-wrap: break-word }
    th { background:#f3f4f6; color:var(--muted) }
    tr:last-child td{ border-bottom:none }
    select { margin-top:6px; padding:6px 8px; font-size:13px; border-radius:6px; border:1px solid var(--border) }
  </style>
</head>
<body>

<div class="app">
  <div class="left">
    <h1>ðŸ“¥ DATA INPUT</h1>

    <h2>A. STOCK</h2>
    <textarea id="stock"></textarea>

    <h2>B. HOLD ORDERS</h2>
    <label for="holdDays">Set Within Days:</label>
    <select id="holdDays">
      <script>
        for(let i=3;i<=15;i++){
          document.write(`<option value="${i}d"${i===10?' selected':''}>${i}d</option>`);
        }
      </script>
    </select>
    <textarea id="hold" placeholder="Paste HOLD ORDERS here. Last column must include dropdown value."></textarea>

    <h2>C. SHIPPED ITEMS</h2>
    <textarea id="shipped" placeholder="Each row must include X multiplier, e.g., 2 X ITEM"></textarea>

    <h2>D. RETURN TO SENDER</h2>
    <textarea id="rts"></textarea>

    <h2>E. FROM SUPPLIER</h2>
    <textarea id="supplier"></textarea>

    <button class="btn full" onclick="compute()">COMPUTE</button>
  </div>

  <div class="right">
    <h1>ðŸ“Š RESULT</h1>
    <div class="copy-tables">
      <div>
        <button class="btn ghost" onclick="copyText('stockCopy')">ðŸ“‹ COPY STOCK</button>
        <textarea id="stockCopy" readonly></textarea>
      </div>
      <div>
        <button class="btn ghost" onclick="copyText('restockCopy')">ðŸ“‹ COPY RESTOCK</button>
        <textarea id="restockCopy" readonly></textarea>
      </div>
    </div>
    <table id="result" style="display:none">
      <thead>
        <tr>
          <th style="width:40%">ITEM NAME</th>
          <th style="width:30%">STOCK RESULT</th>
          <th style="width:30%">RESTOCK RESULT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbya0HoYzb5zlm8s_IBw8eceEEgEnEY4q6UEviNcQI06gqtxn1F4QOmjIIk0tNqvoRj-Ng/exec";

/* ================= HELPERS ================= */
function pcs(item){ const m=item.match(/^(\d+)\s*x/i); return m?Number(m[1]):1 }
function clean(item){ return item.replace(/^\d+\s*x\s*/i,'').trim().toUpperCase() }
function num(v){ return Number(String(v||0).replace(/,/g,'')) }
function round100(n){ return n<=0?0:Math.ceil(n/100)*100 }

function parse(text,col,multiply=true,dash=false){
  const map={}
  text.split('\n').slice(1).forEach(r=>{
    if(!r.trim()) return
    if(/grand total|auto stock/i.test(r)) return
    if(dash){
      const m=r.split('-')
      if(m.length<2) return
      map[m[0].trim()] = (map[m[0].trim()]||0) + num(m[1])
      return
    }
    const c=r.split(/\t+/)
    if(!c[col]) return
    const name = clean(c[0])
    let qty = num(c[col])
    if(multiply) qty *= pcs(c[0])
    map[name] = (map[name]||0)+qty
  })
  return map
}

/* ================= UPLOAD EXTRACTION ================= */
function extractStockUpload(){
  const out=[]
  stockCopy.value.split('\n').forEach(l=>{
    if(!l.trim()) return
    if(/AUTO STOCK/i.test(l)) return
    if(l.includes('-')){
      const p=l.split('-')
      if(p.length<2) return
      out.push({ item: p[0].trim(), qty: Number(p[1].trim().replace(/,/g,'')) })
    }
  })
  return out
}

function extractHoldUpload(){
  const out=[]
  holdEl.value.split('\n').forEach(l=>{
    if(!l.trim()) return
    const p=l.split(/\t+/)
    if(p.length<2) return
    out.push({ item: clean(p[0]), qty: Number(p[1].trim().replace(/,/g,'')) * pcs(p[0]) })
  })
  return out
}

function extractHoldUploadRaw(){
  const out=[]
  holdEl.value.split('\n').forEach(l=>{
    if(!l.trim()) return
    const p=l.split(/\t+/)
    if(p.length<2) return
    out.push({ item: p[0].trim(), qty: Number(p[1].trim().replace(/,/g,'')) })
  })
  return out
}

function extractShippedUpload(){
  const out=[]
  shippedEl.value.split('\n').forEach(l=>{
    if(!l.trim()) return
    const p=l.split(/\t+/)
    if(p.length<2) return
    const multiplier = pcs(p[0])
    const qty = Number(p[1].trim().replace(/,/g,'')) * multiplier
    out.push({ item: p[0].trim(), qty: qty })
  })
  return out
}

/* ================= VALIDATION ================= */
function validateShippedItems(){
  const lines = shippedEl.value.split('\n').filter(l=>l.trim());
  if(lines.length < 2){
    alert("SHIPPED ITEMS must have at least one item row!");
    return false;
  }
  if(!/X/i.test(lines[1])){ // 2nd row check
    alert("First item row of SHIPPED ITEMS must contain 'X' multiplier!");
    return false;
  }
  return true;
}

function validateHoldAndShipped(){
  const holdDays = document.getElementById('holdDays').value;
  const holdLines = holdEl.value.split('\n').filter(l=>l.trim());
  if(holdLines.length === 0){
    alert("HOLD ORDERS is empty!");
    return false;
  }
  const firstRow = holdLines[0].trim().split(/\t/);
  const withinValue = firstRow[firstRow.length-1].trim();
  if(!withinValue.includes(holdDays)){
    alert(`HOLD ORDERS first row last column must include '${holdDays}'!`);
    return false;
  }
  return validateShippedItems();
}

/* ================= MAIN ================= */
function compute(){
  if(!validateHoldAndShipped()) return;

  const today=new Date().toLocaleDateString('en-CA')
  const stock=parse(stockEl.value,0,false,true)
  const hold=parse(holdEl.value,1,true)
  const order=parse(holdEl.value,2,true)
  const shipped=parse(shippedEl.value,1,true)
  const rts=parse(rtsEl.value,2,false)
  const supplier=parse(supplierEl.value,0,false,true)

  const items=new Set([...Object.keys(stock),...Object.keys(hold),...Object.keys(order)])
  const tbody=document.querySelector('#result tbody')
  tbody.innerHTML=''

  let sOut='', rOut=''

  items.forEach(i=>{
    const demand=(hold[i]||0)+(order[i]||0)
    const cur=(stock[i]||0)+(rts[i]||0)+(supplier[i]||0)-(shipped[i]||0)
    const safeCur=Math.max(cur,0)
    const rest=round100(Math.max(demand-safeCur,0))
    tbody.innerHTML+=`<tr><td>${i}</td><td>${safeCur}</td><td>${rest}</td></tr>`
    if(safeCur) sOut+=`${i} - ${safeCur}\n`
    if(rest) rOut+=`${i} - ${rest}\n`
  })

  stockCopy.value=`AUTO STOCK (${today})\n\n${sOut}`
  restockCopy.value=`AUTO RESTOCK (${today})\n\n${rOut}`
  result.style.display='table'

  fetch(WEB_APP_URL,{
    method:'POST',
    mode:'no-cors',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      stock: extractStockUpload(),
      hold: extractHoldUpload(),
      hold_raw: extractHoldUploadRaw(),
      shipped: extractShippedUpload()
    })
  })
}

/* ================= COPY ================= */
function copyText(id){
  const el=document.getElementById(id)
  el.select()
  document.execCommand('copy')
}

/* ================= ELEMENTS ================= */
const stockEl=document.getElementById('stock'),
      holdEl=document.getElementById('hold'),
      shippedEl=document.getElementById('shipped'),
      rtsEl=document.getElementById('rts'),
      supplierEl=document.getElementById('supplier'),
      stockCopy=document.getElementById('stockCopy'),
      restockCopy=document.getElementById('restockCopy'),
      result=document.getElementById('result')
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PDF Extractor â€“ Odd "Piece:" Lines</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f0f0f0; }
    .table-header {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px; /* dagdag spacing para hindi dikit sa file input */
      margin-bottom: 5px;
    }
    .copy-btn {
      padding: 6px 10px;
      font-size: 14px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .copy-btn:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

  <h2>Upload PDF â€“ Extract Value Before Odd "Piece:" Lines</h2>
  <input type="file" id="pdfInput" multiple accept=".pdf">
  <div id="output"></div>

  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

    document.getElementById('pdfInput').addEventListener('change', async (event) => {
      const files = Array.from(event.target.files);
      const extractedItems = [];

      for (const file of files) {
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
          const page = await pdf.getPage(pageNum);
          const content = await page.getTextContent();
          const lines = [];

          // Group text into lines based on Y position
          let lastY = null;
          let line = [];
          content.items.forEach(item => {
            if (lastY !== null && Math.abs(item.transform[5] - lastY) > 5) {
              lines.push(line.join(' ').trim());
              line = [];
            }
            line.push(item.str);
            lastY = item.transform[5];
          });
          if (line.length) lines.push(line.join(' ').trim());

          // Find odd-numbered Piece lines and get the value before it
          let pieceCount = 0;
          for (let i = 0; i < lines.length; i++) {
            if (lines[i].includes("Piece:")) {
              pieceCount++;
              if (pieceCount % 2 === 1 && i > 0) { // Only odd-numbered "Piece:"
                const value = lines[i - 1].trim();
                if (value) extractedItems.push(value);
              }
            }
          }
        }
      }

      // Count occurrences
      const countMap = {};
      extractedItems.forEach(item => {
        countMap[item] = (countMap[item] || 0) + 1;
      });

      // Display result + copy button ABOVE but aligned right
      const outputDiv = document.getElementById('output');
      let tableHTML = `
        <div class="table-header">
          <button class="copy-btn" onclick="copyTable('resultTable')">ðŸ“‹ Copy Table</button>
        </div>
        <table id="resultTable">
          <tr><th>Value before Odd "Piece:"</th><th>Count</th></tr>`;
      for (const [key, value] of Object.entries(countMap)) {
        tableHTML += `<tr><td>${key}</td><td>${value}</td></tr>`;
      }
      tableHTML += `</table>`;
      outputDiv.innerHTML = tableHTML;
    });

    // Copy Table Function (NO HEADER)
    function copyTable(tableId) {
      const table = document.getElementById(tableId);
      let text = "";

      // skip the first row (header)
      for (let i = 1; i < table.rows.length; i++) {
        let rowData = [];
        for (let cell of table.rows[i].cells) {
          rowData.push(cell.innerText);
        }
        text += rowData.join("\t") + "\n"; // tab-separated for Excel/Sheets
      }

      navigator.clipboard.writeText(text).then(() => {
        alert("âœ… Table data copied.");
      });
    }
  </script>

</body>
</html>

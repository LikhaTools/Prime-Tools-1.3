<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PDF COUNTER</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>

<style>
:root{
  --bg:#f4f6f8;
  --card:#ffffff;
  --muted:#64748b;
  --border:#3b82f6;
  --primary:#3b82f6;
  --primary-weak:#e8efff;
  --text:#0f172a;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
h1{margin:0 0 12px;font-size:20px}
h2{font-size:13px;color:var(--muted);margin-top:16px}

.app{display:grid;grid-template-columns:32% 68%;height:100vh}

.left{
  background:var(--card);
  padding:16px 16px 16px 48px;
  border-right:1px solid #e5e7eb;
  overflow:auto;
}

.right{
  padding:20px;
  background:var(--card);
  overflow:auto;
}

input[type=file]{
  width:100%;
  padding:10px;
  border:1px solid #e5e7eb;
  border-radius:8px;
  margin-top:6px;
}

.btn{
  padding:10px 14px;
  font-size:13px;
  background:var(--primary);
  color:#fff;
  border:none;
  border-radius:10px;
  cursor:pointer;
  margin-top:16px;
}
.btn:hover{opacity:.9}
.btn.ghost{background:var(--primary-weak);color:var(--primary)}
.btn.full{width:100%}

table{
  width:100%;
  border-collapse:collapse;
  border:1px solid var(--border);
  border-radius:10px;
  margin-top:10px;
}
th,td{
  border-bottom:1px solid var(--border);
  padding:10px;
  font-size:13px;
  text-align:center;
}
th{background:#f3f4f6;color:var(--muted)}
tr:last-child td{border-bottom:none}

.header-actions{
  display:flex;
  justify-content:flex-end;
  margin-bottom:10px;
}
</style>
</head>

<body>

<div class="app">

  <!-- LEFT -->
  <div class="left">
    <h1>ðŸ“„ PDF COUNTER</h1>
    <h2>UPLOAD PDF FILES</h2>
    <input type="file" id="pdfInput" multiple accept=".pdf">
    <button class="btn full" onclick="resetAll()">RESET</button>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <h1>ðŸ“Š RESULT</h1>

    <div class="header-actions">
      <button class="btn ghost" onclick="sendToSheet()">ðŸ“¤ Proceed to GSheet</button>
    </div>

    <table id="resultTable" style="display:none">
      <thead>
        <tr>
          <th style="width:70%">VALUE</th>
          <th style="width:30%">COUNT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzKWxGO0Wr5juCG1loy-DGta3rYrtiRiY1hbZxkwYrDjd42Rv81zCXQCv52-uviI4E/exec";

const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

let finalData = [];

document.getElementById("pdfInput").addEventListener("change", async (e) => {
  const files = [...e.target.files];
  const extracted = [];

  for (const file of files) {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;

    for (let p = 1; p <= pdf.numPages; p++) {
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();

      const lines = [];
      let lastY = null, line = [];

      content.items.forEach(i => {
        if (lastY !== null && Math.abs(i.transform[5] - lastY) > 5) {
          lines.push(line.join(" ").trim());
          line = [];
        }
        line.push(i.str);
        lastY = i.transform[5];
      });
      if (line.length) lines.push(line.join(" ").trim());

      let piece = 0;
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].includes("Piece:")) {
          piece++;
          if (piece % 2 === 1 && i > 0) {
            extracted.push(lines[i - 1]);
          }
        }
      }
    }
  }

  const map = {};
  extracted.forEach(v => map[v] = (map[v] || 0) + 1);

  finalData = Object.entries(map).map(([v,c]) => ({value:v,count:c}));
  renderTable();
});

function renderTable(){
  const tbody = document.querySelector("#resultTable tbody");
  tbody.innerHTML = "";
  finalData.forEach(r=>{
    tbody.innerHTML += `<tr><td>${r.value}</td><td>${r.count}</td></tr>`;
  });
  document.getElementById("resultTable").style.display = "table";
}

function sendToSheet(){
  if(!finalData.length){
    alert("No data to send");
    return;
  }

  fetch(WEB_APP_URL,{
    method:"POST",
    mode:"no-cors",
    body:JSON.stringify(finalData),
    headers:{ "Content-Type":"application/json" }
  });

  alert("âœ… Sent to Google Sheet");
}

function resetAll(){
  finalData=[];
  document.getElementById("resultTable").style.display="none";
  document.getElementById("pdfInput").value="";
}
</script>

</body>
</html>
